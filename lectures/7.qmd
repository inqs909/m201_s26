---
title: "Group <br> Regression"
description: |
  Discuss using categorical predictor variables.

format:
  revealjs:
    width: 1200
    scrollable: true
    sc-sb-title: true
    footer: m201.inqs.info/lectures/7
    theme: [default, styles.scss]
    navigation-mode: vertical
    controls-layout: edges
    controls-tutorial: true
    slide-number: true
    pointer:
      pointerSize: 32
    incremental: false 
    chalkboard:
      theme: whiteboard
      chalk-width: 4
knitr:
  opts_chunk: 
    echo: true
    eval: true
    message: false
    code-fold: true
    warnings: false
    comment: "#>" 
    
revealjs-plugins:
  - pointer
 
  
filters:
  - reveal-header
  - code-fullscreen
  - reveal-auto-agenda

editor: source
---

## R Packages

```{r}
#| include: false
library(tidyverse)
library(rcistats)
library(emmeans)
penguins <- penguins |> drop_na()
heart_disease <- kmed::heart
heart_disease$disease <- factor(ifelse(heart_disease$class == 0, "no", "yes")) 
heart_disease$sex <- ifelse(heart_disease$sex == T, "Male", "Female") |> factor()
heart_disease$cp <- ifelse(heart_disease$cp == 1, "Typical Angina",
                           ifelse(heart_disease$cp == 2, "Atypical Angina", 
                                  ifelse(heart_disease$cp == 3, "Non-anginal Pain", "Asymptomatic"))) |> 
                    factor(levels = c("Asymptomatic", "Non-anginal Pain", "Atypical Angina", "Typical Angina"))
heart_disease$fbs <- ifelse(heart_disease$fbs == T, "Fasting Blood Sugar >120" , "Fasting Blood Sugar <= 120") |> factor()
heart_disease$restecg <- ifelse(heart_disease$restecg == 0, "Normal",
                                ifelse(heart_disease$restecg == 1, "ST-T wave Abnormality", "Left Ventricular Hypertrophy")) |> 
                          factor(levels = c("Normal", "ST-T wave Abnormality", "Left Ventricular Hypertrophy"))
heart_disease$slope <- ifelse(heart_disease$slope == 1, "Positive Slope",
                              ifelse(heart_disease$slope == 2, "Zero Slope", "Negative Slope")) |> 
                              factor(levels = c("Zero Slope", "Positive Slope", "Negative Slope"))
heart_disease$thal <- ifelse(heart_disease$thal==3, "Normal",
                             ifelse(heart_disease$thal == 6, "Fixed Defect", "Reversible Defect")) |> 
                              factor(levels = c("Normal", "Fixed Defect", "Reversible Defect"))
theme_set(theme_bw() + 
          theme(axis.text = element_text(size = 24),
                axis.title = element_text(size = 30),
                plot.title = element_text(size = 48),
                strip.text = element_text(size = 20),
                legend.title = element_blank(),
                legend.text = element_text(size = 24)))
```

-   rcistats
-   tidyverse

## Palmer Penguins Data

::: {.columns}
::: {.column}

### Variables of Interest

- `species`: Penguin species
- `body_mass`: Body mass in [grams](https://en.wikipedia.org/wiki/Gram)

:::
::: {.column}
![Artwork by @allison_horst](img/penguins.png){fig-alt="An image of several penguins in Antartica."}

:::
::: 

## Heart Disease Data

::: {.columns}
::: {.column}

### Variables of Interest

- `thal`: Thallium stress test result
- `disease`: Indicating if they have heart disease

:::
::: {.column}
![](img/heart_df.png){fig-alt="An image of a graph and a heart."}
:::
:::


# Modeling Relationships

## Explaining Continuous Variables

```{r}
#| code-fold: true
ggplot(penguins, aes(body_mass)) +
  geom_density() 

```

## Linear: Categorical Variables

```{r}
#| code-fold: true
ggplot(penguins, aes(body_mass, fill = species)) +
  geom_density(alpha = .5)
```


## Explainging Binary Variables

```{r}
heart_disease |> 
  ggplot(aes(disease)) +
  geom_bar()
```


## Logistic: Categorical Variables

```{r}
heart_disease |> 
  ggplot(aes(disease, fill = thal)) +
  geom_bar()
```

# Group Statistics

## Group Statistics

We can use statistics to explain a variable by the categories.

::: fragment
Compute statistics for each group.
:::


## Continuous Data

```r
num_by_cat_stats(DATA, NUM, CAT)
```

- `NUM`: Name of the numerical variable
- `CAT`: Name of the categorical variable
- `DATA`: Name of the data frame



## Continous Data

```{r}
#| code-fold: false
num_by_cat_stats(penguins, body_mass, species)
```


## Continuous Data

```r
cat_stats(DATA$Y, DATA$X, prop = "row")
```

OR

```r
cat_stats(DATA$X, DATA$Y, prop = "col")
```


- `Y`: Name of the outcome variable
- `X`: Name of the categorical variable
- `DATA`: Name of the data frame

## Binary Data

```{r}
#| code-fold: false
cat_stats(heart_disease$disease, heart_disease$thal, prop = "row")
```


# Group Models

## G/LM with Categorical Variables

A line is normally used to model 2 continuous variables.

::: fragment
However, the predictor variable $X$ can be restricted to a set a **dummy** variables that can symbolize categories.
:::

::: fragment
A category from $X$ will be used as a reference for a model.
:::

## LM Example

$$
body\_mass = \beta_0 + \boldsymbol \beta (species)
$$


::: fragment
$$
body\_mass = \beta_0 + \beta_1 (Chinstrap) + \beta_2 (Gentoo)
$$
:::

::: fragment
$Chinstrap$ and $Gentoo$ are both dummy variables that will reference Adelie
:::

## GLM Example

$$
lo(disease) = \beta_0 + \boldsymbol \beta (thal)
$$


::: fragment
$$
lo(disease) = \beta_0 + \beta_1 (Fixed) + \beta_2 (Reversible)
$$
:::

::: fragment
$Fixed$ and $Reversible$ defects are both dummy variables that will reference Normal
:::

## Dummy Variables

To fit a model with categorical variables, we must utilize dummy (binary) variables that indicate which category is being referenced. We use $C-1$ dummy variables where $C$ indicates the number of categories. When coded correctly, each category will be represented by a combination of dummy variables.


## Dummy Variables

Binary variables are variable that can only take on the value 0 or 1.

$$
D_i = \left\{
\begin{array}{cc}
1 & Category\\
0 & Other
\end{array}
\right.
$$


## Example

If we have 4 categories, we will need 3 dummy variables:

|         | Cat 1 | Cat 2 | Cat 3 | Cat 4 |
|---------|-------|-------|-------|-------|
| Dummy 1 | 1     | 0     | 0     | 0     |
| Dummy 2 | 0     | 1     | 0     | 0     |
| Dummy 2 | 0     | 0     | 1     | 0     |


## Species Dummy Variables

| DUMMY | Chinstrap | Gentoo | Adelie (Reference) |
|-------|-------|-------|-------|
| $Chinstrap$ | 1     | 0     | 0     |
| $Gentoo$ | 0     | 1     | 0     |

## Thal Dummy Variables

| DUMMY  | Fixed Defect | Reversible Defect | Normal (Reference) |
|---------|-------|-------|-------|
| $Fixed$ | 1     | 0     | 0     |
| $Reversible$ | 0     | 1     | 0     |

## LM: Penguins

$$
body\_mass = \hat \beta_0 + \hat\beta_1 (Chinstrap) + \hat\beta_2 (Gentoo)
$$

::: fragment
$\hat \beta_1$ indicates how body mass changes from Adelie to Chinstrap.
:::

::: fragment
$\hat \beta_2$ indicates how body mass changes from Adelie to Gentoo.
:::

::: fragment
$\hat \beta_0$ represents the baseline level, in this case the body mass of Adelie.
:::

## GLM: Penguins

$$
lo(disease) = \hat \beta_0 + \hat\beta_1 (Fixed) + \hat\beta_2 (Reversible)
$$

::: fragment
$\hat \beta_1$ indicates how $lo(disease)$ changes from Normal to Fixed.
:::

::: fragment
$\hat \beta_2$ indicates how $lo(disease)$ changes from Normal to Reversible.
:::

::: fragment
$\hat \beta_0$ represents the baseline level, in this case the $lo(disease)$ of Normal.
:::

## Interepreting $\beta$

Interpreting $\beta$ for categorical variables are different from continuous (numeric) variables. Interpreting $\beta$s only allow us to make comparisons between the dummy indicator category and the reference category

## LM: Interpreting $\beta$

::: {.columns}
::: {.column}

$$
\hat Y = \hat \beta_0 + \hat\beta_1 D
$$

:::
::: {.column}

$$
D = \left\{
\begin{array}{cc}
1 & CAT\\
0 & REF
\end{array}
\right.
$$

:::
::: 

On average, CAT1 has a larger/smaller Y than REF by about $\beta_1$.

## GLM: Interpreting $\beta$

::: {.columns}
::: {.column}

$$
lo(Y) = \hat \beta_0 + \hat\beta_1 D
$$

:::
::: {.column}

$$
D = \left\{
\begin{array}{cc}
1 & CAT\\
0 & REF
\end{array}
\right.
$$

:::
::: 

The odds of having Y is $e^{\beta_1}$ times higher/lower for CAT than Ref. 


# Group Models in R


## Fitting an LM in R

```r
xlm <- lm(Y ~ X, data = DATA)
xlm
```

- `X`: Name Predictor Variable of Interest in data frame `DATA`, must be a factor variable
- `Y`: Name Outcome Variable of Interest in data frame `DATA`
- `DATA`: Name of the data frame

## Fitting an GLM in R

```r
xglm <- glm(Y ~ X, data = DATA, family = binomial())
xglm
```

- `X`: Name Predictor Variable of Interest in data frame `DATA`, must be a factor variable
- `Y`: Name Outcome Variable of Interest in data frame `DATA`
- `DATA`: Name of the data frame


## X not a Factor

```r
xlm <- lm(Y ~ factor(X), data = DATA)
```

OR

```r
xglm <- glm(Y ~ factor(X), data = DATA, family = binomial())
```


- `X`: Name Predictor Variable of Interest in data frame `DATA`, not a factor variable
- `Y`: Name Outcome Variable of Interest in data frame `DATA`
- `DATA`: Name of the data frame


# LM Example

## Example

```{r}
#| code-fold: false
xlm <- lm(body_mass ~ species, penguins)
xlm
```

$$
\hat Y_i = 3706 + 26.92 (Chinstrap) + 1386.27 (Gentoo)
$$

## Intepreting $\hat \beta_1$

On average, Chinstrap has a larger mass than Adelie by about 26.92 grams.

## Intepreting $\hat \beta_2$

On average, Gentoo has a larger mass than Adelie by about 1386.27 grams.


## Finding the Adelie MASS

$$
\hat Y_i = 3706 + 26.92 (0) + 1386.27 (0)
$$

## Finding the Chinstrap MASS

$$
\hat Y_i = 3706 + 26.92 (1) + 1386.27 (0)
$$

## Finding the Gentoo MASS

$$
\hat Y_i = 3706 + 26.92 (0) + 1386.27 (1)
$$


## Prediction in R

::: panel-tabset

### Gentoo

```{r}
#| code-fold: false
xlm <- lm(body_mass ~ species,
            data = penguins)
predict_df <- data.frame(species = "Gentoo")
predict(xlm,
        predict_df)
```

### Chinstrap

```{r}
#| code-fold: false
xlm <- lm(body_mass ~ species,
            data = penguins)
predict_df <- data.frame(species = "Chinstrap")
predict(xlm,
        predict_df)
```

### Adelie

```{r}
#| code-fold: false
xlm <- lm(body_mass ~ species,
            data = penguins)
predict_df <- data.frame(species = "Adelie")
predict(xlm,
        predict_df)
```


:::


# GLM Example

## Example

```{r}
#| code-fold: false
xglm <- glm(disease ~ thal, 
            data = heart_disease, 
            family = binomial())
xglm
```

$$
lo(disease) = -1.233 + 1.926 (Fixed) + 2.415 (Reversible)
$$

## Intepreting $\hat \beta_1$

```{r}
exp(1.926)
```

The odds of having heart disease is 6.86 times higher for a patient who has a fixed defect than a patient who is normal.

## Intepreting $\hat \beta_2$

```{r}
exp(2.415)
```

The odds of having heart disease is 11.19 times higher for a patient who has a reversible defect than a patient who is normal.

## Prediction in R

::: panel-tabset

### Fixed Defect

```{r}
#| code-fold: false
xglm <- glm(disease ~ thal, data = heart_disease,
            family = binomial())
pdf <- data.frame(thal = "Fixed Defect")
predict(xglm, pdf, type = "response")
```

### Reversible Defect

```{r}
#| code-fold: false
xglm <- glm(disease ~ thal, data = heart_disease,
            family = binomial())
pdf <- data.frame(thal = "Reversible Defect")
predict(xglm, pdf, type = "response")
```

### Normal

```{r}
#| code-fold: false
xglm <- glm(disease ~ thal, data = heart_disease,
            family = binomial())
pdf <- data.frame(thal = "Normal")
predict(xglm, pdf, type = "response")
```

:::
